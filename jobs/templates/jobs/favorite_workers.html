{% extends 'jobs/_base.html' %}
{% load static %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="min-h-screen bg-gradient-to-tr from-indigo-50 via-purple-50 to-pink-50 py-12 px-6">
  <div class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-extrabold text-indigo-800 font-serif mb-4">My Favorite Workers</h1>
      <p class="text-lg text-indigo-600 max-w-2xl mx-auto">
        Your saved professionals for quick access. Contact them directly or book appointments.
      </p>
    </div>

    {% if favorite_workers %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
      {% for favorite in favorite_workers %}
      {% with worker=favorite.worker %}
      <div class="group relative">
        <!-- Remove Favorite Button -->
        <button 
          class="favorite-btn absolute top-4 right-4 z-10 bg-white bg-opacity-90 rounded-full p-2 shadow-lg hover:scale-110 transition-transform duration-200 favorited"
          data-worker-id="{{ worker.id }}"
          title="Remove from favorites"
        >
          <span class="favorite-icon text-xl">‚ù§Ô∏è</span>
          <span class="favorite-text sr-only">Remove from Favorites</span>
        </button>
        
        <a href="{% url 'worker_service_details' worker.id %}" class="block">
          <div class="bg-white bg-opacity-90 rounded-2xl shadow-xl hover:shadow-2xl transform hover:scale-105 transition duration-300 ease-in-out overflow-hidden h-full">
            <div class="p-6 flex flex-col items-center text-center space-y-4">
              <div class="flex-shrink-0">
                {% if worker.profile_pic %}
                <img
                  class="w-28 h-28 object-cover rounded-full border-4 border-indigo-400 group-hover:border-pink-400 transition"
                  src="{{ worker.profile_pic.url }}"
                  alt="Profile pic"
                  loading="lazy"
                >
                {% else %}
                <div class="w-28 h-28 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-600 font-bold text-2xl">
                  {{ worker.name|slice:":1" }}
                </div>
                {% endif %}
              </div>

              <div class="flex flex-col space-y-3 w-full">
                <p class="text-2xl font-extrabold text-indigo-900 group-hover:text-pink-600 transition">{{ worker.name }}</p>

                <div class="flex justify-center">
                  {% if worker.verified %}
                  <span
                    class="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold flex items-center space-x-2 text-sm"
                    title="Verified Worker"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Verified</span>
                  </span>
                  {% else %}
                  <span
                    class="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold flex items-center space-x-2 text-sm"
                    title="Not Verified"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span>Not Verified</span>
                  </span>
                  {% endif %}
                </div>

                <p class="text-gray-700 italic text-base leading-relaxed">{{ worker.tagline }}</p>

                <div class="space-y-2">
                  {% if worker.location %}
                  <p class="text-gray-600 font-medium flex items-center justify-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm">{{ worker.location }}</span>
                  </p>
                  {% endif %}

                  {% if favorite.distance_km is not None %}
                  <p class="text-indigo-700 font-semibold flex items-center justify-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    <span class="text-sm">{{ favorite.distance_km }} km away</span>
                  </p>
                  {% endif %}
                </div>
                
                <div class="flex flex-col items-center space-y-3">
                  <div class="flex items-center justify-center space-x-1">
                    {% for _ in worker.full_stars %}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="gold" class="drop-shadow-md">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                      </svg>
                    {% endfor %}

                    {% if worker.half_star %}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" class="drop-shadow-md">
                        <defs>
                          <clipPath id="half-mask-{{ worker.id }}">
                            <rect x="0" y="0" width="50%" height="100%" />
                          </clipPath>
                        </defs>
                        <path fill="gold" clip-path="url(#half-mask-{{ worker.id }})"
                              d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                        <path fill="gray"
                              d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                      </svg>
                    {% endif %}

                    {% for _ in worker.empty_stars %}
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="gray" class="drop-shadow-sm">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                      </svg>
                    {% endfor %}
                  </div>

                  <div class="text-center">
                    <span class="text-indigo-900 font-bold text-xl">{{ worker.average_rating }} / 5</span>
                    <br>
                    <span class="text-indigo-600 font-medium text-sm">({{ worker.total_ratings }} reviews)</span>
                  </div>
                </div>

                <!-- Favorited Date -->
                <div class="text-xs text-gray-500 mt-2">
                  Added {{ favorite.favorited_at|timesince }} ago
                </div>
              </div>
            </div>

            <div class="px-6 py-4 bg-indigo-100 rounded-b-xl text-center">
              <button
                class="w-full px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold rounded-lg shadow-md hover:shadow-xl hover:scale-105 transform transition duration-300 ease-in-out"
              >
                View Details & Book
              </button>
            </div>
          </div>
        </a>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16">
      <div class="max-w-md mx-auto">
        <div class="text-6xl mb-4">ü§ç</div>
        <h2 class="text-2xl font-bold text-indigo-700 mb-4">No Favorite Workers Yet</h2>
        <p class="text-indigo-600 mb-8">
          Start exploring professionals and add them to your favorites for quick access!
        </p>
        <a 
          href="{% url 'worker-list' %}" 
          class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-300"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
          </svg>
          Browse Workers
        </a>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
  $(document).ready(function() {
    // Favorite toggle functionality
    $('.favorite-btn').on('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const btn = $(this);
      const workerId = btn.data('worker-id');
      const isFavorite = btn.hasClass('favorited');
      
      $.ajax({
        url: '{% url "toggle_favorite_worker" 0 %}'.replace('0', workerId),
        type: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.success) {
            if (response.is_favorite) {
              btn.addClass('favorited');
              btn.find('.favorite-icon').html('‚ù§Ô∏è');
              btn.attr('title', 'Remove from favorites');
            } else {
              btn.removeClass('favorited');
              btn.find('.favorite-icon').html('ü§ç');
              btn.attr('title', 'Add to favorites');
              
              // If on favorites page, remove the card
              if (window.location.pathname === '{% url "favorite_workers_list" %}') {
                btn.closest('.group').fadeOut(300, function() {
                  $(this).remove();
                  
                  // Check if no favorites left
                  if ($('.group').length === 0) {
                    location.reload(); // Reload to show empty state
                  }
                });
              }
            }
            
            showMessage(response.message, 'success');
          }
        },
        error: function(xhr) {
          showMessage('Error updating favorites', 'error');
        }
      });
    });

    function showMessage(message, type) {
      const messageDiv = $('<div class="fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300"></div>');
      
      if (type === 'success') {
        messageDiv.addClass('bg-green-500');
      } else {
        messageDiv.addClass('bg-red-500');
      }
      
      messageDiv.text(message);
      $('body').append(messageDiv);
      
      setTimeout(function() {
        messageDiv.fadeOut(300, function() {
          $(this).remove();
        });
      }, 3000);
    }
  });
</script>

<style>
  .favorite-btn.favorited {
    background: linear-gradient(135deg, #fce4ec, #f8bbd9);
  }

  .favorite-btn.favorited .favorite-icon {
    animation: heartBeat 0.6s ease-in-out;
  }

  @keyframes heartBeat {
    0% { transform: scale(1); }
    25% { transform: scale(1.3); }
    50% { transform: scale(1); }
    75% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
</style>
{% endblock content %}