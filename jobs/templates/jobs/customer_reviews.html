{% extends "jobs/customer_base.html" %}
{% load static %}

{% block title %}My Reviews - AppointMate{% endblock %}

{% block content %}
<div class="mb-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-2">My Reviews</h1>
  <p class="text-gray-600 text-lg">View all the reviews you've given to workers</p>
</div>

{% if ratings %}
  <div class="space-y-6" id="reviews-container">
    {% for rating in ratings %}
      <div class="bg-white rounded-2xl shadow-lg p-8 border-l-4 border-indigo-500 transition-all duration-300 hover:shadow-xl relative" id="review-{{ rating.id }}" data-review-id="{{ rating.id }}">
        <!-- Delete Button - ADDED DIRECT ONCLICK -->
        <button 
          type="button"
          class="delete-review-btn absolute top-4 right-4 px-4 py-2 bg-red-50 text-red-600 hover:bg-red-600 hover:text-white rounded-lg transition-all duration-200 font-semibold text-sm flex items-center gap-2 shadow-sm hover:shadow-md"
          title="Delete this review"
          data-review-id="{{ rating.id }}"
          data-worker-name="{{ rating.worker.name }}"
          onclick="deleteReview('{{ rating.id }}', '{{ rating.worker.name|escapejs }}')"
        >
          <i class="fas fa-trash-alt"></i>
          Delete
        </button>

        <div class="flex items-start space-x-6">
          <!-- Worker Avatar -->
          <div class="flex-shrink-0">
            {% if rating.worker.profile_pic %}
              <img src="{{ rating.worker.profile_pic.url }}" alt="{{ rating.worker.name }}" class="w-20 h-20 rounded-full object-cover shadow-md">
            {% else %}
              <div class="w-20 h-20 bg-gradient-to-br from-indigo-100 to-indigo-200 rounded-full flex items-center justify-center shadow-md">
                <span class="text-indigo-600 font-bold text-2xl">{{ rating.worker.name|first }}</span>
              </div>
            {% endif %}
          </div>

          <div class="flex-1">
            <!-- Worker Info -->
            <div class="flex items-center justify-between mb-4 pr-24">
              <div>
                <h3 class="text-xl font-bold text-gray-800">{{ rating.worker.name }}</h3>
                <p class="text-gray-600 text-lg">{{ rating.worker.tagline }}</p>
              </div>
              <div class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                {{ rating.created_at|date:"M j, Y" }}
              </div>
            </div>

            <!-- Rating Stars -->
            <div class="flex items-center mb-4">
              {% for star in "12345" %}
                {% if forloop.counter <= rating.rating %}
                  <i class="fas fa-star text-yellow-400 text-xl"></i>
                {% else %}
                  <i class="far fa-star text-gray-300 text-xl"></i>
                {% endif %}
              {% endfor %}
              <span class="ml-3 text-gray-700 font-semibold text-lg">{{ rating.rating }}/5</span>
            </div>

            <!-- Review Comment -->
            {% if rating.comment %}
              <div class="bg-gray-50 rounded-xl p-5 mb-4 border border-gray-200">
                <p class="text-gray-700 text-lg italic">"{{ rating.comment }}"</p>
              </div>
            {% endif %}

            <!-- Appointment Details -->
            {% if rating.appointment %}
              <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5 border border-blue-200">
                <h4 class="font-semibold text-gray-800 text-lg mb-3">Appointment Details</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                  <div class="flex items-center">
                    <i class="far fa-calendar text-blue-500 text-lg mr-3"></i>
                    <span>{{ rating.appointment.appointment_date|date:"F j, Y g:i A" }}</span>
                  </div>
                  {% if rating.appointment.service_subtask %}
                    <div class="flex items-center">
                      <i class="fas fa-tools text-blue-500 text-lg mr-3"></i>
                      <span>{{ rating.appointment.service_subtask.subtask.name }}</span>
                    </div>
                  {% endif %}
                  {% if rating.appointment.location %}
                    <div class="md:col-span-2 flex items-center">
                      <i class="fas fa-map-marker-alt text-blue-500 text-lg mr-3"></i>
                      <span>{{ rating.appointment.location }}</span>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

{% else %}
  <!-- Empty State -->
  <div class="bg-white rounded-2xl shadow-lg p-12 text-center transition-all duration-300 hover:shadow-xl">
    <div class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fas fa-star text-gray-400 text-4xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-800 mb-4">No Reviews Yet</h3>
    <p class="text-gray-600 text-lg mb-8 max-w-md mx-auto">You haven't reviewed any workers yet. Complete some appointments and share your experience!</p>
    <a href="{% url 'worker-list' %}" class="inline-block bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-4 rounded-xl hover:shadow-lg transition-all text-lg font-semibold">
      <i class="fas fa-search mr-3"></i>
      Find Workers
    </a>
  </div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl p-8 max-w-md mx-4 w-full transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
    <div class="text-center">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Review</h3>
      <p class="text-gray-600 mb-6" id="modalMessage">Are you sure you want to delete your review for this worker? This action cannot be undone.</p>
      
      <div class="flex space-x-4 justify-center">
        <button 
          type="button" 
          id="cancelDeleteBtn"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition-colors duration-200 font-semibold"
        >
          Cancel
        </button>
        <button 
          type="button" 
          id="confirmDeleteBtn"
          class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors duration-200 font-semibold"
        >
          Delete Review
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-2xl p-8 flex items-center space-x-4">
    <div class="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
    <span class="text-gray-700 font-semibold">Deleting review...</span>
  </div>
</div>

<script>
// Global delete function
window.deleteReview = function(reviewId, workerName) {
    if (!confirm('Are you sure you want to delete your review for ' + workerName + '? This action cannot be undone.')) {
        return;
    }
    
    // Show loading spinner
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.classList.remove('hidden');
    }
    
    // Get CSRF token
    const csrfToken = getCSRFToken();
    
    if (!csrfToken) {
        alert('Security error: Please refresh the page and try again.');
        if (loadingSpinner) loadingSpinner.classList.add('hidden');
        return;
    }
    
    // Send the delete request
    fetch('/delete-worker-review/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            review_id: reviewId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Remove the review element from the page
            const reviewElement = document.getElementById(`review-${reviewId}`);
            if (reviewElement) {
                // Add fade-out animation
                reviewElement.style.opacity = '0';
                reviewElement.style.transform = 'translateX(-100px)';
                reviewElement.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    reviewElement.remove();
                    
                    // Show success message
                    alert('✅ Review deleted successfully!');
                    
                    // Check if no reviews left
                    const remainingReviews = document.querySelectorAll('[id^="review-"]');
                    
                    if (remainingReviews.length === 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                }, 300);
            } else {
                alert('✅ Review deleted successfully!');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } else {
            throw new Error(data.error || 'Delete failed on server');
        }
    })
    .catch(error => {
        alert('❌ Failed to delete review: ' + error.message);
    })
    .finally(() => {
        // Hide loading spinner
        if (loadingSpinner) {
            loadingSpinner.classList.add('hidden');
        }
    });
};

// CSRF token function
function getCSRFToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    return cookieValue;
}

// Simple button setup to ensure onclick works
function setupDeleteButtons() {
    const buttons = document.querySelectorAll('.delete-review-btn');
    
    buttons.forEach((button) => {
        const reviewId = button.getAttribute('data-review-id');
        const workerName = button.getAttribute('data-worker-name');
        
        // Ensure onclick attribute is set
        button.setAttribute('onclick', `deleteReview('${reviewId}', '${workerName}')`);
    });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    setupDeleteButtons();
});
</script>
{% endblock %}